name: Update Documentation on PR Merge

on:
  pull_request:
    types: [closed]
    paths-ignore:
      # README.mdã¨CLAUDE.mdã®å¤‰æ›´ã¯é™¤å¤–
      - 'README.md'
      - 'CLAUDE.md'
      - '**/README.md'
      - '**/CLAUDE.md'

jobs:
  update-documentation:
    # PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            mcp_servers:
              - 'article_3_custom-mcp-server/**/src/**'
              - 'article_3_custom-mcp-server/**/test/**'
              - 'article_3_custom-mcp-server/**/package.json'
            readme_files:
              - '**/README.md'
            github_actions:
              - '.github/workflows/**'
            article_4:
              - 'article_4_autonomous-use-case/**'
      
      - name: Update documentation with Claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          timeout_minutes: "30"
          mode: "edit"
          direct_prompt: |
            ä»¥ä¸‹ã®å¤‰æ›´ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦README.mdã¨CLAUDE.mdã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
            
            ## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            ### MCPã‚µãƒ¼ãƒãƒ¼é–¢é€£: ${{ steps.changed-files.outputs.mcp_servers_all_changed_files }}
            ### README: ${{ steps.changed-files.outputs.readme_files_all_changed_files }}
            ### GitHub Actions: ${{ steps.changed-files.outputs.github_actions_all_changed_files }}
            ### ç¬¬4ç« ã‚µãƒ³ãƒ—ãƒ«: ${{ steps.changed-files.outputs.article_4_all_changed_files }}
            
            ## æ›´æ–°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
            
            1. **æ–°ã—ã„MCPã‚µãƒ¼ãƒãƒ¼ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆ**:
               - README.mdã®ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
               - å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è©³ç´°èª¬æ˜ã‚’è¿½åŠ 
               - CLAUDE.mdã®ã€Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã€ã‚’æ›´æ–°
            
            2. **æ—¢å­˜ã®MCPã‚µãƒ¼ãƒãƒ¼ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆ**:
               - æ©Ÿèƒ½è¿½åŠ ãŒã‚ã‚Œã°README.mdã®è©²å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
               - æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ã‚„APIãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚Œã°è¿½è¨˜
            
            3. **GitHub ActionsãŒè¿½åŠ /æ›´æ–°ã•ã‚ŒãŸå ´åˆ**:
               - README.mdã®ã€Œç¬¬4ç« ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
               - CLAUDE.mdã®ã€ŒGitHub Actionsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            
            4. **ç¬¬4ç« ã®ã‚µãƒ³ãƒ—ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ**:
               - README.mdã®ã€Œç¬¬4ç« : è‡ªå¾‹çš„æ´»ç”¨äº‹ä¾‹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
               - æ–°ã—ã„ã‚µãƒ³ãƒ—ãƒ«ã®èª¬æ˜ã‚’è¿½åŠ 
            
            5. **package.jsonãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ**:
               - æ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚Œã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ 
               - ä¾å­˜é–¢ä¿‚ã®é‡è¦ãªå¤‰æ›´ãŒã‚ã‚Œã°ã€Œå¿…è¦æ¡ä»¶ã€ã‚’æ›´æ–°
            
            ## æ³¨æ„äº‹é …
            - æ—¢å­˜ã®å†…å®¹ã¯å¯èƒ½ãªé™ã‚Šä¿æŒã™ã‚‹
            - æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹
            - æŠ€è¡“çš„ãªæ­£ç¢ºæ€§ã‚’ä¿ã¤
            - README.mdã¯åˆå¿ƒè€…ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã
            - CLAUDE.mdã¯é–‹ç™ºè€…å‘ã‘ã®è©³ç´°æƒ…å ±ã‚’å«ã‚ã‚‹
            
            å¤‰æ›´ãŒå¿…è¦ãªã„å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ãªã„ã§ãã ã•ã„ã€‚
            
            ## ã‚³ãƒŸãƒƒãƒˆæ–¹æ³•
            å¿…è¦ãªå¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ã€GitHubã®gitã‚³ãƒãƒ³ãƒ‰ã¾ãŸã¯GitHub MCP Serverã‚’ä½¿ç”¨ã—ã¦ï¼š
            1. å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
            2. ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒŸãƒƒãƒˆï¼š
               "ğŸ“ Update documentation after PR #${{ github.event.pull_request.number }} merge"
            3. æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥